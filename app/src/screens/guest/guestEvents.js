import React, { useState, useEffect } from "react";
import {
    SafeAreaView,
    View,
    Text,
    TouchableOpacity,
    TextInput,
    ScrollView,
    Alert,
} from "react-native";
import { LinearGradient } from "expo-linear-gradient";
import styles from "./guestEvents.style";
import { useRouter, useLocalSearchParams } from "expo-router";
import { collection, getDocs, doc, getDoc, updateDoc, setDoc } from "firebase/firestore";
import { db } from "../../../../configs/FirebaseConfig";
import DateTimePickerModal from "react-native-modal-datetime-picker";

export default function GuestEvents() {
    const router = useRouter();
    const { userId, userName } = useLocalSearchParams();
    const [searchText, setSearchText] = useState("");
    const [events, setEvents] = useState([]);
    const [filteredEvents, setFilteredEvents] = useState([]);
    const [selectedDate, setSelectedDate] = useState(new Date()); // üìå Kullanƒ±cƒ±nƒ±n se√ßtiƒüi tarih
    const [isDatePickerVisible, setDatePickerVisibility] = useState(false); // üìå Tarih se√ßici g√∂r√ºn√ºrl√ºƒü√º

    const showDatePicker = () => {
        setDatePickerVisibility(true);
    };

    const hideDatePicker = () => {
        setDatePickerVisibility(false);
    };

    const handleConfirm = (date) => {
        setSelectedDate(date);
        hideDatePicker();
    };

    useEffect(() => {
        const fetchEvents = async () => {
            try {

                const selectedYear = selectedDate.getFullYear().toString();
                const selectedMonth = (selectedDate.getMonth() + 1).toString().padStart(2, "0");

                console.log(`Veri alƒ±nƒ±yor: Yƒ±l = ${selectedYear}, Ay = ${selectedMonth}`);

                const eventsRef = collection(db, "events", selectedYear, selectedMonth);
                const eventsSnapshot = await getDocs(eventsRef);

                if (eventsSnapshot.empty) {
                    console.log("Se√ßilen ayda etkinlik bulunamadƒ±.");
                    setEvents([]); // üìå Eƒüer etkinlik yoksa listeyi bo≈üalt
                    setFilteredEvents([]);
                    return;
                }

                const eventsList = eventsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    title: doc.data().eventTittle,
                    date: doc.data().eventDate,
                    limit: doc.data().eventLimit,
                    applyCount: doc.data().eventApplyCounter,
                    score: doc.data().eventScore,
                }));
                
                setEvents(eventsList);
                setFilteredEvents(eventsList);
            } catch (error) {
                console.error("Etkinlik verileri alƒ±nƒ±rken hata olu≈ütu:", error.message);
                Alert.alert("Hata", "Etkinlik verileri alƒ±nƒ±rken bir hata olu≈ütu.");
            }
        };
        fetchEvents();
    }, [selectedDate]);

    const handleSearch = (text) => {
        setSearchText(text);
        const filtered = events.filter((event) =>
            event.title.toLowerCase().includes(text.toLowerCase())
        );
        setFilteredEvents(filtered);
    };

    const handleApplyEvent = async (event) => {
        try {
            if (!event || !event.title) {
                Alert.alert("Hata", "Etkinlik bilgisi eksik. L√ºtfen tekrar deneyin.");
                return;
            }
            
            console.log(`Ba≈üvuru i≈ülemi ba≈ülatƒ±ldƒ±: Etkinlik ID: ${event.id}, Kullanƒ±cƒ± ID: ${userId}, Kullanƒ±cƒ± Adƒ±: ${userName}`);
            
            if (!userId || !userName) {
                console.error("Ba≈üvuru ba≈üarƒ±sƒ±z: userId veya userName eksik!");
                Alert.alert("Hata", "Kullanƒ±cƒ± bilgileri eksik. L√ºtfen tekrar giri≈ü yapƒ±n.");
                return;
            }
    
            // Eƒüer ba≈üvuru limiti dolmu≈üsa ba≈üvuruyu engelle
            if (parseInt(event.applyCount, 10) >= parseInt(event.limit, 10)) {
                Alert.alert("Kontenjan Doldu", "Etkinliƒüin kontenjan sayƒ±sƒ± dolmu≈ütur.");
                return;
            }
    
            // üìå Kullanƒ±cƒ±nƒ±n se√ßtiƒüi yƒ±l ve ayƒ± al
            const selectedYear = selectedDate.getFullYear().toString();
            const selectedMonth = (selectedDate.getMonth() + 1).toString().padStart(2, "0");
    
            // üìå Firestore'daki yollarƒ± belirle
            const participantRef = doc(db, "events", selectedYear, selectedMonth, event.id, "Particant", userId);
            const nonParticipantRef = doc(db, "events", selectedYear, selectedMonth, event.id, "NonParticant", userId);

            // üìå Aynƒ± i≈ülemi "pastEvents" koleksiyonu i√ßin de yapalƒ±m
            const pastParticipantRef = doc(db, "pastEvents", selectedYear, selectedMonth, event.id, "Particant", userId);
            const pastNonParticipantRef = doc(db, "pastEvents", selectedYear, selectedMonth, event.id, "NonParticant", userId);

            // Kullanƒ±cƒ±nƒ±n zaten ba≈üvurduƒüunu kontrol et
            const participantSnap = await getDocs(collection(db, "events", selectedYear, selectedMonth, event.id, "Particant"));
            const nonParticipantSnap = await getDocs(collection(db, "events", selectedYear, selectedMonth, event.id, "NonParticant"));
    
            const isUserAlreadySelected =
                participantSnap.docs.some((doc) => doc.id === userId) ||
                nonParticipantSnap.docs.some((doc) => doc.id === userId);
    
            if (isUserAlreadySelected) {
                Alert.alert("Bilgilendirme", "Etkinlik i√ßin se√ßiminizi zaten yapmƒ±≈üsƒ±nƒ±z.");
                return;
            }
    
            // üìå Ba≈üvuru tarih ve saatini olu≈ütur
            const now = new Date();
            const formattedDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")}--${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}:${now.getSeconds().toString().padStart(2, "0")}`;
    
            // üìå Kullanƒ±cƒ±yƒ± Firestore'a kaydet ve ba≈üvuru zamanƒ±nƒ± ekle
            await setDoc(participantRef, { 
                Name: userName,
                appliedAt: formattedDate // Ba≈üvuru tarih ve saat bilgisi
            });

            // üìå Aynƒ± i≈ülemi "pastEvents" koleksiyonu i√ßin de yapalƒ±m
            await setDoc(pastParticipantRef, { 
                Name: userName,
                appliedAt: formattedDate // Ba≈üvuru tarih ve saat bilgisi
            });
    
            // eventApplyCounter'ƒ± artƒ±r
            const eventRef = doc(db, "events", selectedYear, selectedMonth, event.id);
            const newApplyCount = (parseInt(event.applyCount, 10) + 1);
    
            await updateDoc(eventRef, {
                eventApplyCounter: newApplyCount
            });

            // eventApplyCounter'ƒ± artƒ±r (pastEvents)
            const pastEventRef = doc(db, "pastEvents", selectedYear, selectedMonth, event.id);
            await updateDoc(pastEventRef, {
                eventApplyCounter: newApplyCount
            });
    
            console.log(`Ba≈üvuru sayƒ±sƒ± g√ºncellendi: Yeni Deƒüer = ${newApplyCount}`);
            
            setEvents((prevEvents) =>
                prevEvents.map((e) =>
                    e.id === event.id ? { ...e, applyCount: newApplyCount } : e
                )
            );
    
            // **Kullanƒ±cƒ±nƒ±n Admin mi Guest mi olduƒüunu belirle ve rating deƒüerini g√ºncelle**
            let userCollection = "guests"; // Varsayƒ±lan olarak guest
            let userDocRef = doc(db, "guests", userId);
            let userDoc = await getDoc(userDocRef);
    
            // Eƒüer Admin koleksiyonunda varsa onu kullan
            if (!userDoc.exists()) {
                userCollection = "admin";
                userDocRef = doc(db, "admin", userId);
                userDoc = await getDoc(userDocRef);
            }
    
            // Kullanƒ±cƒ± verisini kontrol et
            if (userDoc.exists()) {
                const userData = userDoc.data();
                const currentRating = userData.rating ? parseInt(userData.rating) : 0;
                const currentRatingCounter = userData.ratingCounter ? parseInt(userData.ratingCounter) : 0;
    
                console.log(`Mevcut Rating: ${currentRating}`);
                console.log(`Mevcut Rating Counter: ${currentRatingCounter}`);
    
                // Etkinlik puanƒ±nƒ± kullanƒ±cƒ± ratingine ekle
                const eventScore = event.score ? parseInt(event.score) : 0;
                const newRating = currentRating + eventScore;
                const newRatingCounter = currentRatingCounter + 1; 
    
                console.log(`Yeni Rating: ${newRating}`);
                console.log(`Yeni Rating Counter: ${newRatingCounter}`);
    
                // **Veritabanƒ±ndaki `eventPublish: 1` olan etkinlikleri say**
                const eventsSnapshot = await getDocs(collection(db, "events", selectedYear, selectedMonth));
                let totalPublishedEvents = 0;
    
                eventsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (parseInt(data.eventPublish) === 1) {
                        totalPublishedEvents++;
                    }
                });
    
                console.log(`Toplam Yayƒ±nlanan Etkinlik: ${totalPublishedEvents}`);
    
                // **Turnout Hesaplamasƒ±**
                let newTurnout = 0;
                if (totalPublishedEvents > 0) {
                    newTurnout = Math.round((newRatingCounter / totalPublishedEvents) * 100);
                }
    
                console.log(`Yeni Turnout: ${newTurnout}`);
    
                // Firestore'da g√ºncelle
                await updateDoc(userDocRef, {
                    rating: newRating.toString(),
                    ratingCounter: newRatingCounter.toString(),
                    turnout: newTurnout.toString()
                });
    
                console.log(`Rating, Rating Counter ve Turnout G√ºncellendi.`);
            } else {
                console.warn("Hata: Kullanƒ±cƒ± bulunamadƒ±.");
            }
    
            Alert.alert("Ba≈üarƒ±", `${event?.title || "Etkinlik"} etkinliƒüine ba≈üarƒ±yla katƒ±ldƒ±nƒ±z!`);
        } catch (error) {
            console.error("Ba≈üvuru yapƒ±lƒ±rken hata olu≈ütu:", error.message);
            Alert.alert("Hata", "Ba≈üvuru yapƒ±lƒ±rken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyiniz.");
        }
    };
    
    const handleDeclineEvent = async (event) => {
        try {
            console.log(`Katƒ±lmama tercihi ba≈ülatƒ±ldƒ±: Etkinlik ID: ${event.id}, Kullanƒ±cƒ± ID: ${userId}, Kullanƒ±cƒ± Adƒ±: ${userName}`);
    
            if (!userId || !userName) {
                Alert.alert("Hata", "Kullanƒ±cƒ± bilgileri eksik. L√ºtfen tekrar giri≈ü yapƒ±n.");
                return;
            }
    
            // üìå Kullanƒ±cƒ±nƒ±n se√ßtiƒüi yƒ±l ve ayƒ± al
            const selectedYear = selectedDate.getFullYear().toString();
            const selectedMonth = (selectedDate.getMonth() + 1).toString().padStart(2, "0");
    
            // üìå Kullanƒ±cƒ±nƒ±n Firestore'daki yolunu belirle
            const participantSnap = await getDocs(collection(db, "events", selectedYear, selectedMonth, event.id, "Particant"));
            const nonParticipantSnap = await getDocs(collection(db, "events", selectedYear, selectedMonth, event.id, "NonParticant"));
    
            console.log("Katƒ±lmama tercihi - ParticipantSnap:", participantSnap.docs.map(d => d.id));
            console.log("Katƒ±lmama tercihi - NonParticipantSnap:", nonParticipantSnap.docs.map(d => d.id));
    
            const isUserAlreadySelected =
                participantSnap.docs.some((doc) => doc.id === userId) ||
                nonParticipantSnap.docs.some((doc) => doc.id === userId);
    
            if (isUserAlreadySelected) {
                Alert.alert("Bilgilendirme", "Etkinlik i√ßin se√ßiminizi zaten yapmƒ±≈üsƒ±nƒ±z.");
                return;
            }
    
            // üìå Katƒ±lmama tarih ve saatini olu≈ütur
            const now = new Date();
            const formattedDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, "0")}-${now.getDate().toString().padStart(2, "0")}--${now.getHours().toString().padStart(2, "0")}:${now.getMinutes().toString().padStart(2, "0")}:${now.getSeconds().toString().padStart(2, "0")}`;
    
            // üìå Kullanƒ±cƒ±yƒ± "NonParticant" olarak kaydet ve tarih bilgisini ekle
            const nonParticipantRef = doc(db, "events", selectedYear, selectedMonth, event.id, "NonParticant", userId);
            await setDoc(nonParticipantRef, { 
                Name: userName,
                appliedAt: formattedDate // Katƒ±lmama tarihi
            });

            // üìå Aynƒ± i≈ülemi "pastEvents" koleksiyonu i√ßin de yapalƒ±m
            const pastNonParticipantRef = doc(db, "pastEvents", selectedYear, selectedMonth, event.id, "NonParticant", userId);
            await setDoc(pastNonParticipantRef, { 
                Name: userName,
                appliedAt: formattedDate // Katƒ±lmama tarihi
            });
    
            // üìå eventNonApplyCounter'ƒ± artƒ±r
            const eventRef = doc(db, "events", selectedYear, selectedMonth, event.id);
            const eventDoc = await getDoc(eventRef);
    
            if (eventDoc.exists()) {
                const eventData = eventDoc.data();
                const currentNonApplyCount = parseInt(eventData.eventNonApplyCounter || 0, 10); // Sayƒ±ya √ßevir, yoksa 0 al
                const newNonApplyCount = currentNonApplyCount + 1;
    
                await updateDoc(eventRef, {
                    eventNonApplyCounter: newNonApplyCount
                });
    
                console.log(`NonParticant sayƒ±sƒ± g√ºncellendi: Yeni eventNonApplyCounter = ${newNonApplyCount}`);
    
                // **React state'ini g√ºncelle**
                setEvents((prevEvents) =>
                    prevEvents.map((e) =>
                        e.id === event.id ? { ...e, eventNonApplyCounter: newNonApplyCount } : e
                    )
                );
            } else {
                console.warn("Hata: G√ºncellenmek istenen etkinlik bulunamadƒ±.");
            }
    
            // üìå eventNonApplyCounter'ƒ± artƒ±r (pastEvents)
            const pastEventRef = doc(db, "pastEvents", selectedYear, selectedMonth, event.id);
            const pastEventDoc = await getDoc(pastEventRef);

            if (pastEventDoc.exists()) {
                const pastEventData = pastEventDoc.data();
                const currentPastNonApplyCount = parseInt(pastEventData.eventNonApplyCounter || 0, 10);
                const newPastNonApplyCount = currentPastNonApplyCount + 1;

                await updateDoc(pastEventRef, {
                    eventNonApplyCounter: newPastNonApplyCount
                });

                console.log(`NonParticant sayƒ±sƒ± g√ºncellendi (pastEvents): Yeni eventNonApplyCounter = ${newPastNonApplyCount}`);
            } else {
                console.warn("Hata: G√ºncellenmek istenen etkinlik (pastEvents) bulunamadƒ±.");
            }

            Alert.alert("Bilgilendirme", "Etkinliƒüe katƒ±lmama tercihiniz kaydedildi ve kontenjan g√ºncellendi.");
            
        } catch (error) {
            console.error("Katƒ±lmama tercihi yapƒ±lƒ±rken hata olu≈ütu:", error.message);
            Alert.alert("Hata", "Katƒ±lmama tercihiniz kaydedilirken bir hata olu≈ütu. L√ºtfen daha sonra tekrar deneyiniz.");
        }
    };
    
    
    const renderEvent = (event) => (
        <View key={event.id} style={styles.eventCard}>
            <View style={styles.eventDetails}>
                <Text style={styles.eventName}>{event.title}</Text>
                <Text style={styles.eventDate}>{event.date}</Text>
                <Text style={styles.eventQuota}>{event.applyCount} / {event.limit}</Text>
                <Text style={styles.eventPoint}>Etkinlik Puanƒ±: {event.score} </Text>
            </View>
            <View style={styles.buttonContainer}>
                <TouchableOpacity
                    style={styles.applyButton}
                    onPress={() => handleApplyEvent(event)}
                >
                    <Text style={styles.buttonText}>Katƒ±l</Text>
                </TouchableOpacity>
                <TouchableOpacity
                     style={styles.cancelButton}
                     onPress={() => handleDeclineEvent(event)}
                >
                    <Text style={styles.buttonText}>Katƒ±lma</Text>
                </TouchableOpacity>
            </View>
        </View>
    );

    return (
        <SafeAreaView style={styles.container}>
            <LinearGradient colors={["#FFFACD", "#FFD701"]} style={styles.background}>
                <TouchableOpacity
                    style={styles.backButton}
                    onPress={() => router.back()}
                >
                    <Text style={styles.backIcon}>{"<"}</Text>
                </TouchableOpacity>

                <View style={styles.header}>
                    <Text style={styles.headerText}>G√∂n√ºll√º Etkinlikleri</Text>
                </View>

                {/* üìå Yƒ±l ve Ay Se√ßme Butonu */}
                <TouchableOpacity onPress={showDatePicker} style={styles.datePickerButton}>
                    <Text style={styles.datePickerText}>
                        {selectedDate ? `${selectedDate.getFullYear()} - ${(selectedDate.getMonth() + 1).toString().padStart(2, "0")}` : "Yƒ±l ve Ay Se√ß"}
                    </Text>
                </TouchableOpacity>

                {/* üìå Tarih Se√ßici Modal */}
                <DateTimePickerModal
                    isVisible={isDatePickerVisible}
                    mode="date"
                    display="spinner"
                    onConfirm={handleConfirm}
                    onCancel={hideDatePicker}
                    minimumDate={new Date(2000, 0, 1)}
                    maximumDate={new Date(2030, 11, 31)}
                />

                <View style={styles.searchContainer}>
                    <TextInput
                        style={styles.searchInput}
                        placeholder="Etkinlik ara..."
                        placeholderTextColor="#888"
                        value={searchText}
                        onChangeText={handleSearch}
                    />
                </View>

                <ScrollView contentContainerStyle={styles.scrollableList}>
                    {(searchText ? filteredEvents : events).map(renderEvent)}
                </ScrollView>

                <View style={styles.warningContainer}>
                    <Text style={styles.warningText}>
                        Ba≈üvuru yaptƒ±ktan sonra hi√ßbir ≈üekilde ba≈üvurunuzu geri √ßekemezsiniz, bu y√ºzden ba≈üvururken l√ºtfen dikkat ediniz.
                    </Text>
                </View>
            </LinearGradient>
        </SafeAreaView>
    );
}